<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω B√†i N·ªôp | Gi√°o Vi√™n 6A3</title>
    <style>
        /* Thi·∫øt l·∫≠p chung */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f0f8ff; 
            color: #333;
        }
        /* --- HEADER (Gi·ªØ nguy√™n ƒë√£ s·ª≠a l·ªói) --- */
        .header {
            background-color: #388E3C; 
            color: white;
            padding: 10px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            font-size: 1.8em;
            font-weight: bold;
        }
        .nav-links {
            display: flex; 
            align-items: center;
        }
        .nav-links a {
            color: white; 
            text-decoration: none; 
            padding: 8px 15px; 
            border-radius: 4px; 
            margin-left: 10px;
            transition: background-color 0.3s;
        }
        .nav-links a.active {
            background-color: #4CAF50; 
            font-weight: bold;
        }
        #user-info-container {
            display: flex; 
            align-items: center; 
            margin-left: 20px;
        }
        #welcome-user {
            color: #FFC107; 
            font-weight: bold; 
            margin-right: 20px; 
            font-size: 1.1em;
            padding: 0; 
        }
        #logout-btn {
            background-color: #e74c3c; 
            cursor: pointer; 
            padding: 8px 15px;
        }
        #logout-btn:hover { 
            background-color: #c0392b; 
        }
        /* --- K·∫æT TH√öC HEADER --- */

        /* Main Content */
        .main-area {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        
        /* --- KH·ªêI M·ªöI: Thanh C√¥ng c·ª• Qu·∫£n l√Ω v√† B·ªô L·ªçc --- */
        .management-tools {
            background-color: #e8f5e9; /* N·ªÅn xanh nh·∫°t h∆°n */
            border: 1px solid #c8e6c9;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .filter-group label {
            font-weight: bold;
            color: #388E3C;
        }
        .filter-group select, .filter-group input[type="search"] {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1em;
            min-width: 150px;
        }
        #search-input {
            min-width: 250px;
        }
        .summary-note {
            font-style: italic;
            color: #555;
            font-size: 0.95em;
        }
        /* End Kh·ªëi M·ªõi */

        /* L·ªãch s·ª≠ B√†i N·ªôp */
        .history-section h2 {
            font-size: 2.2em; color: #388E3C; border-bottom: 3px solid #FFC107; padding-bottom: 15px;
            margin-bottom: 30px;
        }
        .history-table {
            width: 100%; border-collapse: collapse; background-color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .history-table th, .history-table td {
            border: 1px solid #ddd; padding: 12px; text-align: left;
            vertical-align: middle;
        }
        .history-table th {
            background-color: #388E3C; color: white; font-weight: bold;
        }
        .history-table tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* Tr·∫°ng th√°i */
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.9em; font-weight: bold; }
        .status-new { background-color: #FFC107; color: #333; }
        .status-checked { background-color: #4CAF50; color: white; }

        /* N√∫t Xem v√† Ch·∫•m */
        .action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 5px;
            transition: opacity 0.2s;
        }
        .btn-view { background-color: #3498db; color: white; }
        .btn-check { background-color: #2ecc71; color: white; }
        .btn-revert { background-color: #f39c12; color: white; }

        /* Footer */
        .footer {
            padding: 20px; text-align: center; background-color: #333;
            color: white; font-size: 0.9em; margin-top: 40px;
        }
    </style>
</head>
<body onload="checkTeacherAccess()">
    <div class="header">
        <div class="logo">
            <span>L·ªöP 6A3 (QU·∫¢N L√ù)</span>
        </div>
        <div class="nav-links">
            <a href="trang_chu_gv.html">Trang Ch·ªß</a> 
            <a href="#" class="active">Ch·∫•m B√†i</a> 
            
            <div id="user-info-container">
                <span id="welcome-user"></span>
                <a href="#" onclick="logout()" id="logout-btn">ƒêƒÉng Xu·∫•t</a>
            </div>
        </div>
    </div>

    <div class="main-area">
        <div class="management-tools">
            <div class="filter-group">
                <label for="status-filter">Tr·∫°ng th√°i:</label>
                <select id="status-filter" onchange="filterSubmissions()">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="Ch∆∞a ch·∫•m">Ch∆∞a ch·∫•m</option>
                    <option value="ƒê√£ ch·∫•m">ƒê√£ ch·∫•m</option>
                </select>

                <label for="type-filter">Lo·∫°i b√†i:</label>
                <select id="type-filter" onchange="filterSubmissions()">
                    <option value="all">T·∫•t c·∫£</option>
                    <option value="video">Video/Thuy·∫øt tr√¨nh</option>
                    <option value="file">T√†i li·ªáu/File</option>
                    <option value="link">Li√™n k·∫øt</option>
                </select>

                <input type="search" id="search-input" placeholder="T√¨m ki·∫øm theo t√™n HS ho·∫∑c T√™n B√†i..." onkeyup="filterSubmissions()">
            </div>
            <div class="summary-note">
                <p>T·ªïng c·ªông: <span id="total-submissions-display" style="font-weight: bold;">0</span> b√†i n·ªôp.</p>
            </div>
        </div>
        
        <div class="history-section">
            <h2>üìù Danh S√°ch B√†i N·ªôp C·ªßa H·ªçc Sinh</h2>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>H·ªçc Sinh</th>
                        <th>T√™n B√†i T·∫≠p</th>
                        <th>Lo·∫°i</th>
                        <th>Th·ªùi gian N·ªôp</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>ƒêi·ªÉm s·ªë</th>
                        <th>Thao T√°c</th>
                    </tr>
                </thead>
                <tbody id="all-submissions-list">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="footer">
        ¬© 2025 L·ªõp 6A3 Chuy√™n Anh | H·ªá th·ªëng Qu·∫£n L√Ω.
    </div>

<script src="db_submissions.js"></script>
    <script>
        // Bi·∫øn n√†y ƒë∆∞·ª£c gi·ªØ l·∫°i ƒë·ªÉ s·ª≠ d·ª•ng cho m·ª•c ƒë√≠ch tra c·ª©u c√°c b√†i n·ªôp c≈©
        let userDisplayNameMap = {}; 

        // --- H√ÄM H·ªñ TR·ª¢: L·∫§Y V√Ä √ÅNH X·∫† DANH S√ÅCH NG∆Ø·ªúI D√ôNG (D√†nh cho b√†i n·ªôp C≈®) ---
        function initializeUserMap() {
            const usersJSON = localStorage.getItem('allUsers');
            const allUsersObject = usersJSON ? JSON.parse(usersJSON) : {};
            userDisplayNameMap = {}; 

            // Chuy·ªÉn ƒë·ªïi Object th√†nh Map: username -> displayName
            Object.keys(allUsersObject).forEach(username => {
                // Ch·ªâ l·∫•y th√¥ng tin h·ªçc sinh ('hs') n·∫øu c·∫ßn, nh∆∞ng t·ªët nh·∫•t l√† l·∫•y h·∫øt
                if (allUsersObject[username].role === 'hs') {
                    userDisplayNameMap[username] = allUsersObject[username].displayName;
                }
            });
        }
        
        // --- CH·ª®C NƒÇNG CH√çNH: KH·ªûI T·∫†O V√Ä KI·ªÇM TRA QUY·ªÄN TRUY C·∫¨P ---
       function checkTeacherAccess() {
    const role = localStorage.getItem('role'); // ƒê·ªçc vai tr√≤
    
    // N·∫øu kh√¥ng ph·∫£i l√† gi√°o vi√™n, chuy·ªÉn h∆∞·ªõng
    if (role !== 'gv') {
        alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y. Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n Gi√°o vi√™n.');
        window.location.href = 'dangnhap.html';
        return;
    }
    // ... n·∫øu th√†nh c√¥ng, hi·ªÉn th·ªã t√™n (displayName)
}
            const loggedInDisplayName = displayName || 'Gi√°o vi√™n'; 
            document.getElementById('welcome-user').textContent = `Xin ch√†o, ${loggedInDisplayName}!`;
            
            // B∆∞·ªõc quan tr·ªçng: Kh·ªüi t·∫°o Map ƒë·ªÉ x·ª≠ l√Ω b√†i n·ªôp c≈©
            initializeUserMap(); 
            loadAllSubmissions();
        }

        function logout() {
            localStorage.removeItem('username');
            localStorage.removeItem('role');
            localStorage.removeItem('displayName'); 
            window.location.href = 'trang_chu.html';
        }

        // --- H√ÄM CH·∫§M ƒêI·ªÇM (markSubmission) (ƒê√£ t·ªëi ∆∞u logic t√™n hi·ªÉn th·ªã) ---
        function markSubmission(id) {
            let submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
            
            const submissionId = parseInt(id); 
            const submissionIndex = submissions.findIndex(sub => sub.id === submissionId);

            if (submissionIndex !== -1) {
                const currentSubmission = submissions[submissionIndex];
                const currentStatus = currentSubmission.status;
                
                // LOGIC C·∫¢I TI·∫æN: ∆Øu ti√™n displayName ƒë∆∞·ª£c l∆∞u trong b√†i n·ªôp
                const studentName = currentSubmission.displayName || userDisplayNameMap[currentSubmission.student] || currentSubmission.student; 
                const title = currentSubmission.title;
                const currentScore = currentSubmission.score !== undefined && currentSubmission.score !== null ? currentSubmission.score : 'Ch∆∞a c√≥';
                
                if (currentStatus === 'ƒê√£ ch·∫•m') {
                    const action = confirm(`B√†i t·∫≠p "${title}" c·ªßa ${studentName} ƒë√£ ƒë∆∞·ª£c ch·∫•m (${currentScore}/10).\n\nNh·∫•n OK ƒë·ªÉ H·ª¶Y CH·∫§M, nh·∫•n Cancel ƒë·ªÉ CH·∫§M L·∫†I.`);
                    
                    if (action) {
                        currentSubmission.status = 'Ch∆∞a ch·∫•m';
                        currentSubmission.score = null;
                        localStorage.setItem('submissions', JSON.stringify(submissions));
                        loadAllSubmissions(); 
                        alert(`ƒê√£ h·ªßy ch·∫•m b√†i "${title}" c·ªßa ${studentName}.`);
                    } else {
                        let score = prompt(`CH·∫§M L·∫†I cho b√†i "${title}" c·ªßa ${studentName}.\nƒêi·ªÉm hi·ªán t·∫°i: ${currentScore}/10. Nh·∫≠p ƒëi·ªÉm m·ªõi (0-10):`);
                        if (score === null) return; 
                        score = parseFloat(score);

                        if (isNaN(score) || score < 0 || score > 10) {
                            alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ª´ 0 ƒë·∫øn 10.");
                            return;
                        }

                        currentSubmission.status = 'ƒê√£ ch·∫•m';
                        currentSubmission.score = score; 
                        localStorage.setItem('submissions', JSON.stringify(submissions));
                        loadAllSubmissions(); 
                        alert(`ƒê√£ c·∫≠p nh·∫≠t ƒëi·ªÉm ${score}/10 cho b√†i "${title}" c·ªßa ${studentName}.`);
                    }
                    return;

                } else {
                    let score = prompt(`Ch·∫•m ƒëi·ªÉm cho b√†i "${title}" c·ªßa ${studentName}.\nNh·∫≠p ƒëi·ªÉm (0-10):`);
                    if (score === null) return; 
                    
                    score = parseFloat(score);

                    if (isNaN(score) || score < 0 || score > 10) {
                        alert("ƒêi·ªÉm kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p ƒëi·ªÉm t·ª´ 0 ƒë·∫øn 10.");
                        return;
                    }

                    currentSubmission.status = 'ƒê√£ ch·∫•m';
                    currentSubmission.score = score; 
                    localStorage.setItem('submissions', JSON.stringify(submissions));
                    loadAllSubmissions(); 
                    alert(`ƒê√£ ch·∫•m ƒëi·ªÉm ${score}/10 cho b√†i "${title}" c·ªßa ${studentName}.`);
                }
            }
        }
        
        // --- H√ÄM XEM B√ÄI (viewSubmission) (Gi·ªØ nguy√™n) ---
        function viewSubmission(link) {
            if (!link || link.trim() === '') {
                alert("B√†i n·ªôp kh√¥ng c√≥ li√™n k·∫øt ƒë·ªÉ m·ªü.");
                return;
            }
            
            let finalLink = link.trim(); 

            if (finalLink.startsWith("file:")) {
                alert("B√†i n·ªôp n√†y l√† d·∫°ng File (Ghi ch√∫). Vui l√≤ng y√™u c·∫ßu h·ªçc sinh g·ª≠i file g·ªëc qua k√™nh kh√°c.");
                return;
            }
            
            if (!(finalLink.startsWith("http://") || finalLink.startsWith("https://"))) {
                finalLink = `https://${finalLink}`;
            }

            window.open(finalLink, '_blank');
        }

        function displayType(type) {
            switch(type) {
                case 'video': return 'Video/TT';
                case 'file': return 'T√†i li·ªáu/File';
                case 'link': return 'Li√™n k·∫øt';
                default: return 'Kh√°c';
            }
        }

        /* --- H√ÄM L·ªåC V√Ä HI·ªÇN TH·ªä (filterSubmissions) (ƒê√£ t·ªëi ∆∞u logic hi·ªÉn th·ªã T√™n HS) --- */
        function filterSubmissions() {
            const statusFilter = document.getElementById('status-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const searchInput = document.getElementById('search-input').value.toLowerCase();
            const submissions = JSON.parse(localStorage.getItem('submissions') || '[]');
            const tableBody = document.getElementById('all-submissions-list');
            tableBody.innerHTML = ''; 
            
            // L·ªçc d·ªØ li·ªáu
            const filteredSubmissions = submissions.filter(sub => {
                // LOGIC C·∫¢I TI·∫æN: ∆Øu ti√™n displayName t·ª´ b√†i n·ªôp, n·∫øu kh√¥ng c√≥ th√¨ tra c·ª©u Map (d√†nh cho b√†i c≈©)
                const studentName = (sub.displayName || userDisplayNameMap[sub.student] || sub.student).toLowerCase(); 
                
                const title = sub.title ? sub.title.toLowerCase() : '';
                const studentUsername = sub.student ? sub.student.toLowerCase() : ''; // username
                
                const statusMatch = statusFilter === 'all' || sub.status === statusFilter;
                const typeMatch = typeFilter === 'all' || sub.type === typeFilter;
                const searchMatch = studentName.includes(searchInput) || 
                                    title.includes(searchInput) ||
                                    studentUsername.includes(searchInput);
                
                return statusMatch && typeMatch && searchMatch;
            });

            // S·∫Øp x·∫øp d·ªØ li·ªáu ƒë√£ l·ªçc 
            filteredSubmissions.sort((a, b) => {
                // ∆Øu ti√™n "Ch∆∞a ch·∫•m" l√™n ƒë·∫ßu
                if (a.status === 'Ch∆∞a ch·∫•m' && b.status !== 'Ch∆∞a ch·∫•m') return -1;
                if (a.status !== 'Ch∆∞a ch·∫•m' && b.status === 'Ch∆∞a ch·∫•m') return 1;
                // Sau ƒë√≥ s·∫Øp x·∫øp theo ID gi·∫£m d·∫ßn (b√†i m·ªõi h∆°n l√™n tr∆∞·ªõc)
                return (b.id || 0) - (a.id || 0); 
            });

            document.getElementById('total-submissions-display').textContent = filteredSubmissions.length;

            if (filteredSubmissions.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">Kh√¥ng t√¨m th·∫•y b√†i n·ªôp n√†o ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán l·ªçc.</td></tr>'; 
                 return;
            }

            // Hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ l·ªçc
            filteredSubmissions.forEach((sub, index) => {
                const badgeClass = sub.status === 'Ch∆∞a ch·∫•m' ? 'status-new' : 'status-checked';
                
                let actionButtonText;
                let actionButtonClass;
                let scoreText;

                if (sub.status === 'Ch∆∞a ch·∫•m') {
                    actionButtonText = 'Ch·∫•m B√†i';
                    actionButtonClass = 'btn-check';
                    scoreText = '<span style="color: #999;">--</span>'; 
                } else {
                    actionButtonText = 'Ch·∫•m L·∫°i/H·ªßy';
                    actionButtonClass = 'btn-revert';
                    const score = sub.score !== undefined && sub.score !== null ? parseFloat(sub.score).toFixed(1) : '<span style="color: red;">L·ªói</span>';
                    scoreText = `<span style="font-weight: bold; color: #E67E22;">${score}</span>/10`; 
                }
                
                let linkToView = sub.link || ''; 
                
                // LOGIC C·∫¢I TI·∫æN: L·∫•y t√™n hi·ªÉn th·ªã
                const studentDisplayName = sub.displayName || userDisplayNameMap[sub.student] || 'L·ªói T√™n';
                
                // T·∫†O H√ÄNG V·ªöI 8 C·ªòT (TD) ƒê·ªÇ KH·ªöP V·ªöI 8 C·ªòT (TH)
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="font-weight: 600;">${studentDisplayName} (<span style="font-style: italic; color: #666;">${sub.student}</span>)</td>
                        <td>${sub.title}</td>
                        <td>${displayType(sub.type)}</td>
                        <td>${sub.date}</td>
                        <td><span class="status-badge ${badgeClass}">${sub.status}</span></td>
                        <td>${scoreText}</td> <td>
                            <button class="action-btn btn-view" onclick="viewSubmission('${linkToView}')">Xem</button>
                            <button class="action-btn ${actionButtonClass}" onclick="markSubmission('${sub.id}')">${actionButtonText}</button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }
        
        function loadAllSubmissions() {
            filterSubmissions();
        }
    </script>

